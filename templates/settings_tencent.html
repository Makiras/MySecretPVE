{% extends 'base.html' %}
{% block content %}
<h2>Tencent Cloud Settings</h2>
{% if message %}
<div class="alert alert-info">{{ message }}</div>
{% endif %}
<form method="post" class="row g-3 col-lg-6" id="tencent-form">
  <div class="col-12">
    <label class="form-label" for="secret">Secret</label>
    <input type="text" class="form-control" id="secret" name="secret" value="{{ settings.secret }}" required>
  </div>
  <div class="col-12">
    <label class="form-label" for="key">Key</label>
    <input type="text" class="form-control" id="key" name="key" value="{{ settings.key }}" required>
  </div>
  <div class="col-12 d-flex gap-2 flex-wrap align-items-center">
    <button type="submit" class="btn btn-primary">保存</button>
    <button type="button" id="btn-test-tencent" class="btn btn-outline-secondary">测试配置</button>
    <div id="tencent-test-spinner" class="spinner-border spinner-border-sm text-secondary ms-1 d-none" role="status"></div>
  </div>
</form>
<div id="tencent-test-result" class="mt-3"></div>

<script>
  (function(){
    const btn = document.getElementById('btn-test-tencent');
    const result = document.getElementById('tencent-test-result');
    const spinner = document.getElementById('tencent-test-spinner');
    const form = document.getElementById('tencent-form');

    function showAlert(ok, msg){
      result.innerHTML = `
        <div class="alert ${ok ? 'alert-success' : 'alert-danger'}" role="alert">
          ${msg}
        </div>`;
    }

    btn?.addEventListener('click', async () => {
      const fd = new FormData(form);
      const payload = {
        secret: fd.get('secret'),
        key: fd.get('key')
      };
      btn.disabled = true; spinner.classList.remove('d-none'); result.innerHTML = '';
      try {
        const res = await fetch(`${window.location.origin}/api/test/tencent`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        showAlert(!!data.ok, data.message || (data.ok ? '凭据有效' : '凭据无效'));
      } catch (e) {
        showAlert(false, '请求失败，请检查网络或服务端日志');
      } finally {
        btn.disabled = false; spinner.classList.add('d-none');
      }
    });
  })();
  </script>
{% endblock %}
