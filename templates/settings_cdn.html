{% extends 'base.html' %}
{% block content %}
<h2>CDN Settings</h2>
{% if message %}
<div class="alert alert-info">{{ message }}</div>
{% endif %}

<div class="row g-4">
  <div class="col-12 col-lg-7">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Sync Targets</span>
        <button type="button" class="btn btn-sm btn-success" id="btn-sync-all">Sync All</button>
      </div>
      <div class="card-body">
        <form method="post" class="row g-3">
          <input type="hidden" name="action" value="save_cdn">
          <div class="col-12">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="enabled" name="enabled" {% if cdn.enabled %}checked{% endif %}>
              <label class="form-check-label" for="enabled">Enable scheduled sync</label>
            </div>
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label" for="interval_minutes">Interval (minutes)</label>
            <input class="form-control" type="number" min="1" id="interval_minutes" name="interval_minutes" value="{{ cdn.interval_minutes }}">
          </div>
          <div class="col-12"><hr></div>
          <div class="col-12 col-md-6">
            <label class="form-label" for="ipset_edgeone">EdgeOne IPSet</label>
            <input class="form-control" type="text" id="ipset_edgeone" name="ipset_edgeone" value="{{ cdn.ipset_edgeone }}">
          </div>
          <div class="col-12 col-md-6 d-flex align-items-end">
            <div class="w-100 d-flex flex-column gap-2">
              <button type="button" class="btn btn-outline-primary w-100" id="btn-sync-edgeone">Sync EdgeOne</button>
              <small class="text-muted">Last: {{ statuses.edgeone.last_time_text }} | {{ 'OK' if statuses.edgeone.last_ok else 'FAIL' }} | {{ statuses.edgeone.last_count }} | {{ statuses.edgeone.last_message }}</small>
            </div>
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label" for="ipset_cloudflare">Cloudflare IPSet</label>
            <input class="form-control" type="text" id="ipset_cloudflare" name="ipset_cloudflare" value="{{ cdn.ipset_cloudflare }}">
          </div>
          <div class="col-12 col-md-6 d-flex align-items-end">
            <div class="w-100 d-flex flex-column gap-2">
              <button type="button" class="btn btn-outline-primary w-100" id="btn-sync-cloudflare">Sync Cloudflare</button>
              <small class="text-muted">Last: {{ statuses.cloudflare.last_time_text }} | {{ 'OK' if statuses.cloudflare.last_ok else 'FAIL' }} | {{ statuses.cloudflare.last_count }} | {{ statuses.cloudflare.last_message }}</small>
            </div>
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label" for="ipset_tencent">Tencent CDN IPSet</label>
            <input class="form-control" type="text" id="ipset_tencent" name="ipset_tencent" value="{{ cdn.ipset_tencent }}">
          </div>
          <div class="col-12 col-md-6 d-flex align-items-end">
            <div class="w-100 d-flex flex-column gap-2">
              <button type="button" class="btn btn-outline-primary w-100" id="btn-sync-tencent">Sync Tencent</button>
              <small class="text-muted">Last: {{ statuses.tencent.last_time_text }} | {{ 'OK' if statuses.tencent.last_ok else 'FAIL' }} | {{ statuses.tencent.last_count }} | {{ statuses.tencent.last_message }}</small>
            </div>
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-primary">Save</button>
            <span id="sync-status" class="ms-2 text-muted"></span>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-5">
    <div class="card">
      <div class="card-header">Tencent CDN Credentials</div>
      <div class="card-body">
        <form method="post" class="row g-3" id="tencent-form">
          <input type="hidden" name="action" value="save_tencent">
          <div class="col-12">
            <label class="form-label" for="secret">Secret</label>
            <input type="text" class="form-control" id="secret" name="secret" value="{{ tencent.secret }}">
          </div>
          <div class="col-12">
            <label class="form-label" for="key">Key</label>
            <input type="text" class="form-control" id="key" name="key" value="{{ tencent.key }}">
          </div>
          <div class="col-12 d-flex gap-2 flex-wrap align-items-center">
            <button type="submit" class="btn btn-primary">保存</button>
            <button type="button" id="btn-test-tencent" class="btn btn-outline-secondary">测试配置</button>
            <div id="tencent-test-spinner" class="spinner-border spinner-border-sm text-secondary ms-1 d-none" role="status"></div>
          </div>
        </form>
        <div id="tencent-test-result" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const status = document.getElementById('sync-status');
  async function sync(provider){
    status.textContent = 'Syncing ' + provider + '...';
    try {
      const res = await fetch(`${window.location.origin}/api/cdn/sync`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ provider })
      });
      const data = await res.json();
      if (data.ok) {
        status.textContent = `Synced ${provider}: ${data.count} entries -> ${data.ipset}`;
      } else {
        status.textContent = `Failed: ${data.message || 'unknown error'}`;
      }
    } catch (e) {
      status.textContent = 'Request failed';
    }
  }
  document.getElementById('btn-sync-edgeone')?.addEventListener('click', () => sync('edgeone'));
  document.getElementById('btn-sync-cloudflare')?.addEventListener('click', () => sync('cloudflare'));
  document.getElementById('btn-sync-tencent')?.addEventListener('click', () => sync('tencent'));
  document.getElementById('btn-sync-all')?.addEventListener('click', async () => {
    status.textContent = 'Syncing all...';
    try {
      const res = await fetch(`${window.location.origin}/api/cdn/sync_all`, { method: 'POST' });
      const data = await res.json();
      if (data.ok) {
        const sums = (data.items||[]).map(i => `${i.provider}:${i.count||0}`).join(', ');
        status.textContent = `All synced: ${sums}`;
      } else {
        const errs = (data.items||[]).filter(i=>!i.ok).map(i => `${i.provider}:${i.message}`).join('; ');
        status.textContent = `Some failed: ${errs}`;
      }
    } catch (e) {
      status.textContent = 'Request failed';
    }
  });

  // Tencent test
  const btn = document.getElementById('btn-test-tencent');
  const result = document.getElementById('tencent-test-result');
  const spinner = document.getElementById('tencent-test-spinner');
  const form = document.getElementById('tencent-form');
  function showAlert(ok, msg){
    result.innerHTML = `<div class="alert ${ok ? 'alert-success' : 'alert-danger'}" role="alert">${msg}</div>`;
  }
  btn?.addEventListener('click', async () => {
    const fd = new FormData(form);
    const payload = { secret: fd.get('secret'), key: fd.get('key') };
    btn.disabled = true; spinner.classList.remove('d-none'); result.innerHTML = '';
    try {
      const res = await fetch(`${window.location.origin}/api/test/tencent`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
      });
      const data = await res.json();
      showAlert(!!data.ok, data.message || (data.ok ? '凭据有效' : '凭据无效'));
    } catch (e) {
      showAlert(false, '请求失败，请检查网络或服务端日志');
    } finally {
      btn.disabled = false; spinner.classList.add('d-none');
    }
  });
})();
</script>
{% endblock %}
